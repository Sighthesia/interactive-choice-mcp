<!doctype html>
<html lang="${lang}">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${title}</title>
    <!-- Early theme initialization to prevent flash -->
    <script>
        (function () {
            try {
                const theme = localStorage.getItem('mcp-theme') || 'system';
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (theme === 'dark' || (theme === 'system' && prefersDark)) {
                    document.documentElement.classList.add('dark');
                }
            } catch (e) {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
            }
        })();
    </script>
    <!-- CSS Bundle Placeholder -->
    ${css_bundle}
</head>

<body>
    <header class="header-bar">
        <a href="https://github.com/Sighthesia/interactive-choice-mcp" class="title-link"
            style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px;">
            <div class="title">
                <span class="title-long">Interactive Choice MCP Web Portal</span>
                <span class="title-short">Interactive Choice</span>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                <path fill="currentColor"
                    d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2" />
            </svg>
        </a>

        <div class="status-item">
            <span class="status-label" data-i18n="label.version">Version:</span>
            <span class="status-value">${mcp_version}</span>
        </div>

        <div class="spacer"></div>

        <div class="status-item">
            <span class="status-label" data-i18n="label.timeout_remaining">Time Left:</span>
            <span id="timeoutText" class="timeout-text">--:--</span>
        </div>

        <div class="status-item">
            <span class="status-label" data-i18n="label.started_at">Invoked:</span>
            <span>${invocation_time}</span>
        </div>

        <div class="status-item">
            <div id="connectionDot" class="status-dot"></div>
            <span class="status-label" data-i18n="label.status">Status:</span>
            <span id="statusText" data-i18n="status.connected">Connected</span>
        </div>

        <!-- Progress Bar integrated at bottom of header -->
        <div id="timeoutContainer" class="timeout-progress-container"
            style="position: absolute; bottom: 0; left: 0; margin-bottom: 0; height: 3px; border-radius: 0;">
            <div id="timeoutProgressBar" class="timeout-progress-bar"></div>
        </div>
    </header>

    <div class="layout">
        <!-- Interaction List (Left Sidebar) -->
        <div class="interaction-list page-load">
            <div class="card collapsible" tabindex="0" aria-expanded="false">
                <div class="card-header config-toggle" onclick="toggleInteractionList()" id="interactionToggle"
                    role="button" tabindex="0" aria-controls="interactionListContent" data-i18n="list.title">
                    Interactions</div>
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="all" onclick="filterInteractions('all')"
                        data-i18n="list.all">All</button>
                    <button class="filter-tab" data-filter="active" onclick="filterInteractions('active')"
                        data-i18n="list.active">Active</button>
                    <button class="filter-tab" data-filter="completed" onclick="filterInteractions('completed')"
                        data-i18n="list.completed">Completed</button>
                </div>
                <div id="interactionListContent">
                    <div class="interaction-empty">Loading interactions...</div>
                </div>
            </div>
        </div>

        <!-- Main Content (Center) -->
        <div class="main-column page-load">
            <h1>${title}</h1>
            <div class="prompt-container">
                <div id="prompt" class="prompt">${prompt}</div>
            </div>

            <!-- Options List -->
            <div id="options" tabindex="0"></div>

            <!-- Additional Annotation Section -->
            <div id="annotationSection" class="annotation-section">
                <div class="annotation-wrapper">
                    <textarea id="additionalAnnotation" rows="2"></textarea>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <button id="submitBatchBtn" class="btn btn-primary" onclick="submitBatch()"
                    data-i18n="action.submit">Submit
                    Selection</button>
                <button id="cancelButton" class="btn btn-danger" onclick="submitCancel()"
                    data-i18n="action.cancel">Cancel</button>
            </div>


            <!-- Status -->
            <div id="status" class="status" style="display:none;"></div>
        </div>

        <!-- Sidebar (Right) - Configuration Panel -->
        <div class="sidebar page-load">
            <div class="card collapsible" tabindex="0" aria-expanded="false">
                <div class="card-header config-toggle" onclick="toggleConfig()" id="configToggle" role="button"
                    tabindex="0" aria-controls="configContent" data-i18n="web.configuration">Configuration</div>
                <div class="config-content" id="configContent">
                    <div class="config-grid">
                        <div class="config-section-title" data-i18n="web.global_settings">Global Settings</div>

                        <div class="config-item">
                            <label class="config-label" id="label-language">
                                <span data-i18n="settings.language">Language</span>
                                <select id="languageSelect" style="margin-left: auto;">
                                    <option value="en" data-i18n="settings.language_en">English</option>
                                    <option value="zh" data-i18n="settings.language_zh">中文</option>
                                </select>
                            </label>
                            <div class="config-desc" data-i18n="desc.language">Switch interface language.</div>
                        </div>

                        <div class="config-item">
                            <label class="config-label">
                                <span data-i18n="settings.interface">Transport</span>
                                <select id="transportSelect" style="margin-left: auto;">
                                    ${transport_options}
                                </select>
                            </label>
                            <div class="config-desc" data-i18n="desc.interface">The communication protocol used by the
                                MCP server.</div>
                        </div>

                        <div class="config-item">
                            <label class="config-label">
                                <span data-i18n="settings.timeout">Timeout (s)</span>
                                <input id="timeoutInput" type="number" min="1" value="${timeout_value}"
                                    style="width:70px; margin-left: auto;" />
                            </label>
                            <div class="config-desc" data-i18n="desc.timeout">Time limit for making a choice before
                                auto-action.</div>
                        </div>

                        <div class="config-item">
                            <label class="config-label">
                                <span data-i18n="settings.timeout_action">Timeout Action</span>
                                <select id="timeoutActionSelect" style="margin-left: auto;">
                                    <option value="submit" data-i18n="settings.timeout_action_submit">Auto-submit
                                        selected</option>
                                    <option value="cancel" data-i18n="settings.timeout_action_cancel">Auto-cancel
                                    </option>
                                    <option value="reinvoke" data-i18n="settings.timeout_action_reinvoke">Request
                                        re-invocation</option>
                                </select>
                            </label>
                            <div class="config-desc" data-i18n="desc.timeout_action">Action to take when the timeout is
                                reached.</div>
                        </div>

                        <div class="config-item" id="item-singleSubmitMode">
                            <label class="config-label">
                                <input id="singleSubmitMode" type="checkbox" ${single_submit_checked} />
                                <span data-i18n="settings.single_submit">Auto Submit on Single Selection Mode</span>
                            </label>
                            <div class="config-desc" data-i18n="desc.single_submit">
                                Automatically submit the selection as soon as an option is clicked
                            </div>
                        </div>

                        <div class="config-item" id="item-useDefaultOption">
                            <label class="config-label">
                                <input id="useDefaultOption" type="checkbox" />
                                <span data-i18n="settings.timeout_default">Use recommended option</span>
                            </label>
                            <div class="config-desc" data-i18n="desc.timeout_default">
                                Auto-select AI recommended options
                            </div>
                        </div>

                        <div class="config-section-title" data-i18n="web.portal_settings">Web Portal Settings</div>

                        <div class="config-item">
                            <label class="config-label">
                                <span data-i18n="web.theme">Theme</span>
                                <select id="themeSelect" style="margin-left: auto;">
                                    <option value="light" data-i18n="web.theme_light">Light</option>
                                    <option value="dark" data-i18n="web.theme_dark">Dark</option>
                                    <option value="system" data-i18n="web.theme_system">System</option>
                                </select>
                            </label>
                            <div class="config-desc" data-i18n="desc.theme">Switch between light, dark, or system theme.
                            </div>
                        </div>

                        <div class="config-section-title" data-i18n="settings.notifications">Notifications</div>

                        <div class="config-item">
                            <label class="config-label">
                                <input type="checkbox" id="notifyNew" />
                                <span data-i18n="settings.notify_new">New interaction</span>
                            </label>
                        </div>

                        <div class="config-item">
                            <label class="config-label">
                                <input type="checkbox" id="notifyUpcoming" />
                                <span data-i18n="settings.notify_upcoming">Upcoming timeout</span>
                            </label>
                            <div class="config-sub-item"
                                style="margin-top: 8px; margin-left: 24px; display: flex; align-items: center; gap: 8px; font-size: 0.875rem;">
                                <span data-i18n="settings.upcoming_threshold">Threshold (s)</span>
                                <input type="number" id="upcomingThreshold" min="1"
                                    style="width: 70px; margin-left: auto;" />
                            </div>
                        </div>

                        <div class="config-item">
                            <label class="config-label">
                                <input type="checkbox" id="notifyTimeout" />
                                <span data-i18n="settings.notify_timeout">Timeout reached</span>
                            </label>
                        </div>

                        <div class="config-section-title" data-i18n="settings.notify_conditions">Trigger Conditions
                        </div>

                        <div class="config-item">
                            <label class="config-label">
                                <span data-i18n="settings.notify_trigger_mode">Trigger Mode</span>
                                <select id="notifyTriggerMode"
                                    style="margin-left: auto; max-width: 180px; flex-shrink: 0;">
                                    <option value="always" data-i18n="settings.trigger_always">Always</option>
                                    <option value="background" data-i18n="settings.trigger_background">Background only
                                    </option>
                                    <option value="tab_switch" data-i18n="settings.trigger_tab_switch">Tab switched
                                    </option>
                                    <option value="focus_lost" data-i18n="settings.trigger_focus_lost">Browser lost
                                        focus
                                    </option>
                                </select>
                            </label>
                            <div class="config-desc" data-i18n="desc.notify_trigger_mode">
                                When to show notifications based on window focus state.
                            </div>
                        </div>

                        <div class="config-item">
                            <label class="config-label">
                                <input type="checkbox" id="notifySound" />
                                <span data-i18n="settings.notify_sound">Notification sound</span>
                                <button type="button" id="testSoundBtn" class="test-sound-btn"
                                    onclick="testNotificationSound()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="currentColor">
                                        <path
                                            d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" />
                                    </svg>
                                    <span data-i18n="settings.test_sound">Test</span>
                                </button>
                            </label>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Injection Blocks -->
    <script type="application/json" id="mcp-defaults">${defaults_json}</script>
    <script type="application/json" id="mcp-options">${options_json}</script>
    <script type="application/json" id="mcp-session-state">${session_state_json}</script>
    <script type="application/json" id="mcp-i18n">${i18n_json}</script>
    <script type="application/json" id="mcp-choice-id">"${choice_id}"</script>
    <script type="application/json" id="mcp-prompt-type">"${prompt_type}"</script>
    <script type="application/json" id="mcp-prompt">${prompt_json}</script>

    <!-- JS Bundle Placeholder -->
    ${js_bundle}
</body>

</html>